---
import "../styles/globa.css";
import { projects } from "../data/home";
import { getAllProjectImages } from "../utils/projectImages";
import ProjectCard from "./ProjectCard.astro";

// Escanear imágenes en build time (servidor)
const projectImagesMap = getAllProjectImages(projects);

// Crear un array de proyectos con sus imágenes válidas
const projectsWithImages = projects.map((project, index) => ({
  ...project,
  projectId: `project-${index}`,
  images: projectImagesMap.get(project.image) || [],
}));
---

<section class="container mx-auto py-20 bg-linear-to-b from-gray-50 to-white">
  <div class="mx-6">
    <div class="flex items-center justify-center mb-8">
      <div class="w-16 h-1 bg-linear-to-r from-primary to-blue-600 rounded-full"></div>
    </div>
    <h2 class="text-4xl md:text-5xl font-bold text-center mb-12 text-gray-800">Proyectos Destacados</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
      {projectsWithImages.map((project) => (
        <ProjectCard
          title={project.title}
          description={project.description}
          image={project.image}
          projectId={project.projectId}
          images={project.images}
        />
      ))}
    </div>
  </div>
</section>

<!-- Modales para cada proyecto -->
{projectsWithImages.map((project) => (
  <div
    id={`modal-container-${project.projectId}`}
    class="modal-container"
    data-project-id={project.projectId}
    data-images={JSON.stringify(project.images)}
    data-title={project.title}
    data-description={project.description}
  ></div>
))}

<script>
  const modalContainers = new Map<string, Element>();
  let currentModalId: string | null = null;

  // Inicializar contenedores de modal
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".modal-container").forEach(function(container) {
      const projectId = container.getAttribute('data-project-id');
      if (projectId) {
        modalContainers.set(projectId, container);
      }
    });
  });

  function closeModal() {
    if (!currentModalId) return;

    const modal = document.getElementById("modal-" + currentModalId);
    if (modal) {
      modal.style.display = "none";
    }
    document.body.style.overflow = "";

    const container = modalContainers.get(currentModalId);
    if (container) {
      container.innerHTML = "";
    }

    currentModalId = null;
  }

  // Listener para abrir el modal desde las tarjetas de proyecto
  document.addEventListener("openProjectModal", (e) => {
    const detail = (e as CustomEvent).detail;
    openModal(detail.projectId, detail.title, detail.description, detail.images);
  });

  function openModal(projectId: string, title: string, description: string, images: string[]) {
    if (currentModalId) closeModal();

    currentModalId = projectId;

    const container = modalContainers.get(projectId);
    if (!container) {
      console.error("No se encontró el contenedor para el proyecto:", projectId);
      return;
    }

    container.innerHTML = "";
    const modalHTML = createModalHTML(projectId, title, description, images);
    container.innerHTML = modalHTML;

    const modal = container.querySelector(".modal-backdrop");
    if (!modal) {
      console.error("No se pudo encontrar el elemento modal después de crearlo");
      return;
    }

    (modal as HTMLElement).style.display = "flex";
    document.body.style.overflow = "hidden";

    setupCloseListeners(projectId);

    setTimeout(() => {
      try {
        initializeModal(projectId, images);
      } catch (error) {
        console.error("Error al inicializar modal:", error);
      }
    }, 50);
  }

  function setupCloseListeners(projectId: string) {
    const modalBackdrop = document.getElementById("modal-" + projectId);
    if (!modalBackdrop) return;

    // Botón de cerrar (X)
    const closeBtn = modalBackdrop.querySelector(".modal-close");
    if (closeBtn) {
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        closeModal();
      });
    }

    // Backdrop click — cerrar solo si el click es directamente en el fondo oscuro
    modalBackdrop.addEventListener("click", (e) => {
      if ((e.target as HTMLElement).classList.contains('modal-backdrop')) {
        closeModal();
      }
    });

    // Keyboard Escape
    function handleEscape(e: KeyboardEvent) {
      if (e.key === "Escape" && currentModalId === projectId) {
        closeModal();
        document.removeEventListener("keydown", handleEscape);
      }
    }
    document.addEventListener("keydown", handleEscape);
  }

  function createModalHTML(projectId: string, title: string, description: string, images: string[]) {
    const escapeHtml = (text: string) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };

    const safeTitle = escapeHtml(title || "");
    const safeDescription = escapeHtml(description || "");

    let slidesHTML = "";
    if (Array.isArray(images) && images.length > 0) {
      slidesHTML = images.map((imgPath, index) => {
        const safePath = escapeHtml(imgPath);
        const isFirst = index === 0;
        return `
          <div class="modal-slide-wrapper absolute inset-0 transition-opacity duration-500 ease-in-out ${isFirst ? 'opacity-100 z-10' : 'opacity-0 z-0'}" data-index="${index}">
            <div class="absolute inset-0 bg-cover bg-center blur-2xl opacity-40" style="background-image: url('${safePath}');"></div>
            <img src="${safePath}" alt="${safeTitle} - Imagen ${index + 1}" class="relative w-full h-full object-contain z-10" loading="${isFirst ? 'eager' : 'lazy'}" onerror="this.parentElement.style.display='none';" />
          </div>
        `;
      }).join("");
    } else {
      slidesHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-400"><p>No hay imágenes disponibles</p></div>';
    }

    let dotsHTML = "";
    if (Array.isArray(images) && images.length > 1) {
      dotsHTML = images.map((_, index) => {
        const isFirst = index === 0;
        return `<button class="modal-dot w-2 h-2 rounded-full transition-all duration-200 ${isFirst ? 'bg-white w-8' : 'bg-white/50'}" data-index="${index}" aria-label="Ir a imagen ${index + 1}"></button>`;
      }).join("");
    }

    const navigationHTML = (Array.isArray(images) && images.length > 1) ? `
      <button class="modal-prev absolute left-2 md:left-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-2 md:p-3 rounded-full shadow-lg transition-all duration-200 hover:scale-110 z-20" aria-label="Imagen anterior">
        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button class="modal-next absolute right-2 md:right-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-2 md:p-3 rounded-full shadow-lg transition-all duration-200 hover:scale-110 z-20" aria-label="Imagen siguiente">
        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 z-20">
        ${dotsHTML}
      </div>
    ` : "";

    const descriptionHTML = safeDescription ? `
      <div class="p-4 md:p-6 bg-white">
        <p class="text-gray-700 leading-relaxed text-base md:text-lg">${safeDescription}</p>
      </div>
    ` : "";

    return `
      <div id="modal-${escapeHtml(projectId)}" class="modal-backdrop fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title-${escapeHtml(projectId)}">
        <div class="flex items-center justify-center w-full h-full">
          <div class="modal-content-wrapper relative w-full max-w-4xl max-h-[90vh] bg-white rounded-xl shadow-2xl overflow-y-auto flex flex-col">
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-200 bg-white sticky top-0 z-10 flex-shrink-0">
              <h2 id="modal-title-${escapeHtml(projectId)}" class="text-xl md:text-2xl font-bold text-gray-800 pr-4">
                ${safeTitle}
              </h2>
              <button class="modal-close text-gray-500 hover:text-gray-700 transition-colors duration-200 p-2 hover:bg-gray-100 rounded-full flex-shrink-0" aria-label="Cerrar modal">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="flex-1">
              <div class="relative w-full h-[40vh] md:h-[55vh] bg-gray-100 overflow-hidden flex items-center justify-center">
                <div class="modal-slider-container relative w-full h-full" data-project-id="${escapeHtml(projectId)}">
                  ${slidesHTML}
                </div>
                ${navigationHTML}
              </div>
              ${descriptionHTML}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function initializeModal(projectId: string, images: string[]) {
    const modal = document.getElementById("modal-" + projectId);
    if (!modal) return;

    const sliderContainer = modal.querySelector(".modal-slider-container");
    if (!sliderContainer) return;

    const slides = Array.from(sliderContainer.querySelectorAll(".modal-slide-wrapper")) as HTMLElement[];
    if (slides.length === 0) return;

    // Asegurar que el primer slide sea visible
    slides.forEach((slide, i) => {
      slide.style.opacity = i === 0 ? "1" : "0";
      slide.style.zIndex = i === 0 ? "10" : "0";
    });

    if (slides.length <= 1) {
      const prevBtn = modal.querySelector(".modal-prev") as HTMLElement | null;
      const nextBtn = modal.querySelector(".modal-next") as HTMLElement | null;
      const dotsContainer = modal.querySelector(".absolute.bottom-4") as HTMLElement | null;
      if (prevBtn) prevBtn.style.display = "none";
      if (nextBtn) nextBtn.style.display = "none";
      if (dotsContainer) dotsContainer.style.display = "none";
      return;
    }

    setupNavigation();

    function setupNavigation() {
      let currentIndex = 0;

      function showSlide(index: number) {
        if (index < 0 || index >= slides.length) return;
        slides.forEach((slide, i) => {
          slide.style.opacity = i === index ? "1" : "0";
          slide.style.zIndex = i === index ? "10" : "0";
        });
        updateDots(index);
      }

      function updateDots(index: number) {
        const dots = modal!.querySelectorAll(".modal-dot");
        dots.forEach((dot, i) => {
          if (i === index) {
            dot.classList.add("bg-white", "w-8");
            dot.classList.remove("bg-white/50");
          } else {
            dot.classList.remove("bg-white", "w-8");
            dot.classList.add("bg-white/50");
          }
        });
      }

      const nextBtn = modal!.querySelector(".modal-next");
      const prevBtn = modal!.querySelector(".modal-prev");

      nextBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex + 1) % slides.length;
        showSlide(currentIndex);
      });

      prevBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        currentIndex = (currentIndex - 1 + slides.length) % slides.length;
        showSlide(currentIndex);
      });

      const dots = modal!.querySelectorAll(".modal-dot");
      dots.forEach((dot, i) => {
        dot.addEventListener("click", (e) => {
          e.stopPropagation();
          currentIndex = i;
          showSlide(currentIndex);
        });
      });

      modal!.addEventListener("keydown", (e: Event) => {
        const ke = e as KeyboardEvent;
        if (ke.key === "ArrowLeft") {
          ke.preventDefault();
          currentIndex = (currentIndex - 1 + slides.length) % slides.length;
          showSlide(currentIndex);
        } else if (ke.key === "ArrowRight") {
          ke.preventDefault();
          currentIndex = (currentIndex + 1) % slides.length;
          showSlide(currentIndex);
        }
      });

      showSlide(0);
    }
  }
</script>
