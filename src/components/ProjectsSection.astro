---
import "../styles/globa.css";
import { projects } from "../data/home";
import { getAllProjectImages } from "../utils/projectImages";
import ProjectCard from "./ProjectCard.astro";

// Escanear imágenes en build time (servidor)
const projectImagesMap = getAllProjectImages(projects);

// Crear un array de proyectos con sus imágenes válidas
const projectsWithImages = projects.map((project, index) => ({
  ...project,
  projectId: `project-${index}`,
  images: projectImagesMap.get(project.image) || [],
}));
---

<section class="container mx-auto py-20 bg-linear-to-b from-gray-50 to-white">
  <div class="mx-6">
    <div class="flex items-center justify-center mb-8">
      <div class="w-16 h-1 bg-linear-to-r from-primary to-blue-600 rounded-full"></div>
    </div>
    <h2 class="text-4xl md:text-5xl font-bold text-center mb-12 text-gray-800">Proyectos Destacados</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
      {projectsWithImages.map((project) => (
        <ProjectCard
          title={project.title}
          description={project.description}
          image={project.image}
          projectId={project.projectId}
          images={project.images}
        />
      ))}
    </div>
  </div>
</section>

<!-- Modales para cada proyecto -->
{projectsWithImages.map((project) => (
  <div
    id={`modal-container-${project.projectId}`}
    class="modal-container"
    data-project-id={project.projectId}
    data-images={JSON.stringify(project.images)}
    data-title={project.title}
    data-description={project.description}
  ></div>
))}

<script>
  const modalContainers = new Map();
  let currentModalId: string | null = null;

  // Inicializar contenedores de modal
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".modal-container").forEach(function(container) {
      const projectId = container.getAttribute('data-project-id');
      if (projectId) {
        modalContainers.set(projectId, container);
      }
    });
  });

  // Función para cerrar modal - MEJORADA para debugging
  function closeModal() {
    console.log("closeModal() llamada, currentModalId:", currentModalId);
    if (!currentModalId) return;
    
    const modal = document.getElementById("modal-" + currentModalId);
    if (modal) {
      modal.style.display = "none";
      console.log("Modal ocultado:", currentModalId);
    }
    document.body.style.overflow = "";
    
    const container = modalContainers.get(currentModalId);
    if (container) {
      container.innerHTML = "";
    }
    
    currentModalId = null;
  }

  // Listener para abrir el modal desde los botones
  document.addEventListener("openProjectModal", (e) => {
    const detail = (e as CustomEvent).detail;
    openModal(detail.id, detail.title, detail.description, detail.images);
  });

  function closeAllModals() {
    // Cerrar cualquier modal abierto
    closeModal();
  }

  function openModal(projectId: string, title: string, description: string, images: string[]) {
    console.log("Abriendo modal para proyecto:", projectId);
    closeAllModals();

    currentModalId = projectId;

    const container = modalContainers.get(projectId);
    if (!container) {
      console.error("No se encontró contenedor para:", projectId);
      return;
    }

    // Limpiar contenedor antes de agregar contenido
    container.innerHTML = "";

    // Crear el HTML del modal
    const modalHTML = createModalHTML(projectId, title, description, images);

    // Insertar el modal en el contenedor
    container.innerHTML = modalHTML;

    // Obtener el modal recién creado
    const modal = document.getElementById(`modal-${projectId}`);
    if (!modal) {
      console.error("No se pudo crear el modal");
      return;
    }

    // Mostrar el modal
    (modal as HTMLElement).style.display = "flex";
    document.body.style.overflow = "hidden";

    // Configurar event listeners
    setupCloseListeners(projectId);

    // Inicializar carrusel de imágenes
    setTimeout(() => {
      initializeModal(projectId, images);
    }, 100);

    console.log("Modal creado y configurado para", projectId);
  }

  function setupCloseListeners(projectId: string) {
    const modal = document.getElementById(`modal-${projectId}`);
    const closeBtns = modal?.querySelectorAll(".close-modal");

    closeBtns?.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log("Botón cerrar clickeado");
        closeModal();
      });
    });

    // Click en el backdrop
    modal?.addEventListener("click", (e) => {
      console.log("Click detectado en:", (e.target as HTMLElement).className);
      if ((e.target as HTMLElement).classList.contains('modal-backdrop')) {
        console.log("Click en backdrop, cerrando modal");
        closeModal();
      }
    });
  }

  // Cerrar modal con tecla Escape
  function handleEscape(e: KeyboardEvent) {
    if (e.key === "Escape") {
      closeAllModals();
    }
  }

  if (typeof window !== "undefined") {
    document.addEventListener("keydown", handleEscape);
  }

  function createModalHTML(projectId: string, title: string, description: string, images: string[]) {
    console.log("Creando HTML del modal con", images.length, "imágenes");

    const escapeHtml = function(text: string) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    };

    const safeTitle = escapeHtml(title);
    const safeDescription = escapeHtml(description);

    let slidesHTML = "";
    if (images.length > 0) {
      slidesHTML = images
        .map((imgPath, index) => {
          return `
          <div class="modal-slide ${index === 0 ? "active" : ""}" data-index="${index}">
            <img 
              src="${imgPath}" 
              alt="${safeTitle} - Imagen ${index + 1}"
              class="modal-image"
              loading="${index === 0 ? "eager" : "lazy"}"
            />
          </div>
        `;
        })
        .join("");
    } else {
      slidesHTML =
        '<div class="flex items-center justify-center h-full"><p class="text-gray-500">No hay imágenes disponibles</p></div>';
    }

    const navigationHTML =
      images.length > 1
        ? `
      <button class="modal-nav modal-prev" aria-label="Imagen anterior">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button class="modal-nav modal-next" aria-label="Imagen siguiente">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <div class="modal-dots">
        ${images.map((_, i) => `<button class="dot ${i === 0 ? "active" : ""}" data-index="${i}"></button>`).join("")}
      </div>
    `
        : "";

    return `
      <div id="modal-${projectId}" class="modal-backdrop" role="dialog" aria-modal="true">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">${safeTitle}</h2>
            <button class="close-modal" aria-label="Cerrar modal">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="modal-slider">
              ${slidesHTML}
            </div>
            ${navigationHTML}
          </div>
          <div class="modal-footer">
            <p class="modal-description">${safeDescription}</p>
          </div>
        </div>
      </div>
    `;
  }

  function initializeModal(projectId: string, images: string[]) {
    console.log("Inicializando modal para", projectId, "con", images.length, "imágenes");
    const modal = document.getElementById(`modal-${projectId}`);
    if (!modal) {
      console.warn("No se encontró el modal:", projectId);
      return;
    }

    if (images.length <= 1) {
      console.log("Solo hay una imagen, no se necesita carrusel");
      return;
    }

    const slides = modal.querySelectorAll(".modal-slide");
    const prevBtn = modal.querySelector(".modal-prev");
    const nextBtn = modal.querySelector(".modal-next");
    const dotsContainer = modal.querySelector(".modal-dots");
    const dots = modal.querySelectorAll(".dot");

    if (slides.length === 0) {
      console.warn("No se encontraron slides");
      return;
    }

    let currentSlideIndex = 0;

    console.log("Configurando carrusel con", slides.length, "slides");

    // Asegurar que el primer slide sea visible
    const firstSlide = slides[0];
    if (firstSlide) {
      console.log("Primer slide encontrado:", firstSlide);
      
      // Limpiar estados de todos los slides primero
      slides.forEach((slide, idx) => {
        if (idx !== 0) {
          if (slide && (slide as HTMLElement).style) {
            (slide as HTMLElement).style.opacity = "0";
            (slide as HTMLElement).style.zIndex = "0";
          }
        }
      });

      // Configurar primer slide
      if (firstSlide && (firstSlide as HTMLElement).style) {
        (firstSlide as HTMLElement).style.opacity = "1";
        (firstSlide as HTMLElement).style.zIndex = "10";
      }

      // Si solo hay 1 imagen, ocultar controles
      if (slides.length <= 1) {
        if (prevBtn) (prevBtn as HTMLElement).style.display = "none";
        if (nextBtn) (nextBtn as HTMLElement).style.display = "none";
        if (dotsContainer) (dotsContainer as HTMLElement).style.display = "none";
      }

      updateDots(currentSlideIndex);

      console.log("Primer slide configurado");
      setTimeout(() => {
        console.log("Slider inicializado para", projectId);
      }, 100);

      function showSlide(index: number) {
        console.log("Mostrando slide:", index);
        const slide = slides[index];
        if (slide && (slide as HTMLElement).style) {
          slides.forEach((s: Element) => {
            (s as HTMLElement).style.opacity = "0";
            (s as HTMLElement).style.zIndex = "0";
          });
          (slide as HTMLElement).style.opacity = "1";
          (slide as HTMLElement).style.zIndex = "10";
          currentSlideIndex = index;
          updateDots(index);
        } else {
          console.warn("Slide no encontrado:", index);
        }
      }

      function updateDots(index: number) {
        const allDots = dotsContainer?.querySelectorAll(".dot");
        allDots?.forEach((dot, i) => {
          if (i === index) {
            dot.classList.add("active");
          } else {
            dot.classList.remove("active");
          }
        });
      }

      function nextSlide() {
        const newIndex = (currentSlideIndex + 1) % slides.length;
        showSlide(newIndex);
      }

      function prevSlide() {
        const newIndex = (currentSlideIndex - 1 + slides.length) % slides.length;
        showSlide(newIndex);
      }

      prevBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        prevSlide();
      });

      nextBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        nextSlide();
      });

      dots?.forEach((dot, index) => {
        dot.addEventListener("click", (e) => {
          e.stopPropagation();
          showSlide(index);
        });
      });

      // Navegación con teclado
      modal.setAttribute("tabindex", "0");
      modal.addEventListener("keydown", (e) => {
        modal.focus();
      });

      function handleKeyDown(e: KeyboardEvent) {
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          prevBtn?.click();
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          nextBtn?.click();
        }
      }

      modal.addEventListener("keydown", handleKeyDown);
    }
  }
</script>
